FROM node:22-alpine

RUN apk add --no-cache libc6-compat

WORKDIR /app

COPY . .

RUN corepack enable pnpm && pnpm i --frozen-lockfile

ENV SKIP_BUILD_STATIC_GENERATION=true
RUN pnpm --filter wiki generate:importmap && pnpm --filter wiki build

EXPOSE 3000
ENV NODE_ENV=production
ENV PORT=3000

CMD ["pnpm", "--filter", "wiki", "start"]